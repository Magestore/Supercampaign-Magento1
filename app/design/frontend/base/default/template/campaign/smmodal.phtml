<!--campaign/smmodal.phtml-->

<?php
$helper = Mage::helper('campaign');
$popups = $this->getAllPopupAvailable();
?>
<?php foreach ($popups as $key => $popup): ?>
    <div id="sc-popup<?php echo $popup->getData('popup_id') ?>"
         class="modal fade sc-popup<?php echo $popup->getData('template_code') ?>" role="dialog">
        <div class="modal-dialog">
            <div class="modal-content">
                <a id="close-<?php echo $popup->getData('popup_id') ?>" class="dialogClose style1 overlay2"
                   data-dismiss="modal"
                   data-target="#sc-popup<?php echo $popup->getData('popup_id') ?>"></a>
                <?php $trigger = '';
                if ($popup->getData('trigger_popup')) $trigger = 'target_popup' . $popup->getData('trigger_popup'); ?>
                <div class="content-popup <?php echo $trigger ?>">
                    <?php echo $helper->convertContentToHtml($popup->getData('popup_content')); ?>
                </div>
            </div>
        </div>
    </div>
<?php endforeach; ?>
<script type="text/javascript">
    var dataPopup = [
        <?php $count = 0; $total = count($popups) ?>
        <?php foreach ($popups as $key => $popup): ?>
        <?php echo json_encode($popup->getData()) ?>
        <?php if ($count < $total - 1) echo ', ' ?>
        <?php $count++; ?>
        <?php endforeach; ?>
    ];
    var Popups = [];
    for (var id = 0; id < dataPopup.length; id++) {
        var Popup = new Scpopup();
        Popup.idPopup = dataPopup[id].popup_id;
        Popup.campaign_id = dataPopup[id].campaign_id;
        Popup.templateCode = dataPopup[id].template_code;
        Popup.effect = dataPopup[id].appear_effect;
        Popup.borderSize = dataPopup[id].border_size;
        Popup.borderColor = dataPopup[id].border_color;
        Popup.paddingSize = dataPopup[id].padding;
        Popup.width = dataPopup[id].width;
        Popup.bgColor = dataPopup[id].popup_background;
        Popup.overlayColor = dataPopup[id].overlay_color;
        Popup.closeStyle = dataPopup[id].close_style;
        Popup.cornerStyle = dataPopup[id].corner_style;
        Popup.cornerRadius = dataPopup[id].border_radius;
        Popup.horizontalPosition = dataPopup[id].horizontal_position;
        Popup.verticalPosition = dataPopup[id].vertical_position;
        Popup.horizontalPx = dataPopup[id].horizontal_px;
        Popup.verticalPx = dataPopup[id].vertical_px;
        Popup.secondDelay = dataPopup[id].seconds_delay;
        Popup.showWhen = dataPopup[id].show_when;
        Popup.status = dataPopup[id].status;
        Popup.priority = id;
        Popup.frequency = dataPopup[id].showing_frequency;
        Popup.urlImages = "<?php echo $this->getBaseUrl();?>" + "skin/frontend/base/default/";
        Popup.cookieUrl = "<?php echo $this->getUrl('campaign/cookie/set');?>";
        Popup.trigger_popup = dataPopup[id].trigger_popup;
        Popups[id] = Popup;

    }
    $j(window).bind("load", function () {
        var triggerPopupIds = [];
        var noTrigger = [];

        for (var i = Popups.length - 1; i >= 0; i--) {
            if (Popups[i].trigger_popup != '' && Popups[i].trigger_popup != null) {
                triggerPopupIds.push(Popups[i].trigger_popup);
            }
            else {
                noTrigger.push(Popups[i].idPopup);
            }
        }
        for (var i = Popups.length - 1; i >= 0; i--) {
            Popups[i].initPopup();
        }
        for (var i = Popups.length - 1; i >= 0; i--) {
            if (Popups[i].frequency == 'only_trigger') {
                continue;
            }
            Popups[i].showPopup();
        }
    });
</script>

